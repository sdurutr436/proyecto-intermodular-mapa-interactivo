name: Generate Project Documentation

on:
  push:
    branches: [main]
    paths:
      - 'backend/**/*.js'
      - 'frontend/src/**/*.ts'
      - 'frontend/src/**/*.tsx'
      - '.github/workflows/jsdoc-generate.yml'
      - 'backend/jsdoc.json'
      - 'typedoc.json'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**/*.js'
      - 'frontend/src/**/*.ts'
      - 'frontend/src/**/*.tsx'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Create docs output directory
        run: mkdir -p docs-generated

      # ========== BACKEND DOCUMENTATION (JSDoc) ==========
      - name: Install backend dependencies
        working-directory: backend
        run: |
          rm -f package-lock.json
          npm install

      - name: Generate Backend JSDoc documentation
        working-directory: backend
        run: npx jsdoc -c jsdoc.json -r

      # ========== FRONTEND DOCUMENTATION (TypeDoc) ==========
      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          rm -f package-lock.json
          npm install

      - name: Install TypeDoc
        working-directory: frontend
        run: npm install --save-dev typedoc@0.25.13 --legacy-peer-deps

      - name: Generate Frontend TypeDoc documentation
        working-directory: frontend
        run: npx typedoc --entryPoints src --entryPointStrategy expand --out ../docs-generated/frontend --exclude '**/node_modules/**' --tsconfig tsconfig.json --name "Frontend Documentation" --includeVersion --excludePrivate

      # ========== CREATE INDEX PAGE ==========
      - name: Create documentation index page
        run: |
          cat > docs-generated/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Documentaci√≥n del Proyecto - Transkarte</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
              }
              .container { 
                text-align: center;
                max-width: 900px;
                width: 100%;
              }
              h1 { 
                color: white;
                font-size: 3rem;
                margin-bottom: 1rem;
                text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
                font-weight: 700;
              }
              .subtitle {
                color: rgba(255,255,255,0.95);
                font-size: 1.3rem;
                margin-bottom: 3rem;
                font-weight: 300;
              }
              .cards { 
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
                margin-bottom: 2rem;
              }
              .card { 
                background: white;
                border-radius: 20px;
                padding: 2.5rem;
                text-decoration: none;
                color: inherit;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                position: relative;
                overflow: hidden;
              }
              .card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 6px;
                background: linear-gradient(90deg, var(--card-color), var(--card-color-light));
              }
              .card:hover { 
                transform: translateY(-12px);
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              }
              .card h2 { 
                font-size: 1.8rem;
                margin-bottom: 1rem;
                color: #1a202c;
                font-weight: 700;
              }
              .card p { 
                color: #4a5568;
                font-size: 1rem;
                line-height: 1.6;
                margin-bottom: 1.5rem;
              }
              .card .icon { 
                font-size: 4rem;
                margin-bottom: 1.5rem;
                display: block;
              }
              .card .cta {
                display: inline-block;
                padding: 0.75rem 1.5rem;
                background: var(--card-color);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                transition: all 0.2s;
              }
              .card:hover .cta {
                transform: scale(1.05);
              }
              .backend {
                --card-color: #38a169;
                --card-color-light: #48bb78;
              }
              .frontend {
                --card-color: #3182ce;
                --card-color-light: #4299e1;
              }
              .footer { 
                margin-top: 3rem;
                color: rgba(255,255,255,0.8);
                font-size: 0.95rem;
              }
              .footer a {
                color: white;
                text-decoration: none;
                font-weight: 600;
                border-bottom: 2px solid rgba(255,255,255,0.5);
                transition: border-color 0.2s;
              }
              .footer a:hover {
                border-bottom-color: white;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üìö Documentaci√≥n T√©cnica</h1>
              <p class="subtitle">Transkarte - Mapa Interactivo de Idiomas</p>
              
              <div class="cards">
                <a href="./backend/" class="card backend">
                  <span class="icon">‚öôÔ∏è</span>
                  <h2>Backend</h2>
                  <p>API REST con Node.js y Express. Documentaci√≥n de endpoints, modelos, servicios de traducci√≥n y rutas de juego.</p>
                  <span class="cta">Ver Documentaci√≥n ‚Üí</span>
                </a>
                
                <a href="./frontend/" class="card frontend">
                  <span class="icon">üé®</span>
                  <h2>Frontend</h2>
                  <p>Aplicaci√≥n React con TypeScript. Componentes, servicios, contextos y tipos de datos.</p>
                  <span class="cta">Ver Documentaci√≥n ‚Üí</span>
                </a>
              </div>
              
              <p class="footer">
                Documentaci√≥n generada autom√°ticamente con JSDoc y TypeDoc<br>
                <a href="https://github.com/sdurutr436/ProyectoIntermodular-MapaInteractivo" target="_blank">Ver Repositorio en GitHub</a>
              </p>
            </div>
          </body>
          </html>
          EOF

      # ========== DEPLOY ==========
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs-generated
          commit_message: 'üìö Update project documentation'
          force_orphan: true

      - name: Comment PR with docs link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üìö La documentaci√≥n estar√° disponible en:\n- **Principal:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\n- **Backend:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/backend/\n- **Frontend:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/frontend/'
            })

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-documentation
          path: docs-generated/
          retention-days: 30
