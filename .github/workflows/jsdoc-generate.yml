name: Generate Project Documentation

on:
  push:
    branches: [main]
    paths:
      - 'backend/**/*.js'
      - 'frontend/src/**/*.ts'
      - 'frontend/src/**/*.tsx'
      - '.github/workflows/jsdoc-generate.yml'
      - 'backend/jsdoc.json'
      - 'typedoc.json'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**/*.js'
      - 'frontend/src/**/*.ts'
      - 'frontend/src/**/*.tsx'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Create docs output directory
        run: mkdir -p docs-generated

      # ========== BACKEND DOCUMENTATION (JSDoc) ==========
      - name: Install backend dependencies
        working-directory: backend
        run: |
          rm -f package-lock.json
          npm install

      - name: Generate Backend JSDoc documentation
        working-directory: backend
        run: npx jsdoc -c jsdoc.json -r

      # ========== FRONTEND DOCUMENTATION (TypeDoc) ==========
      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          rm -f package-lock.json
          npm install

      - name: Install TypeDoc
        working-directory: frontend
        run: npm install --save-dev typedoc@0.25.13 --legacy-peer-deps

      - name: Generate Frontend TypeDoc documentation
        working-directory: frontend
        run: npx typedoc --entryPoints src --entryPointStrategy expand --out ../docs-generated/frontend --exclude '**/node_modules/**' --tsconfig tsconfig.json --name "Frontend Documentation" --includeVersion --excludePrivate

      # ========== CREATE INDEX PAGE ==========
      - name: Create documentation index page
        run: |
          cat > docs-generated/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Documentaci贸n del Proyecto - Mapa Interactivo</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
              .container { text-align: center; padding: 2rem; }
              h1 { color: white; font-size: 2.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
              p { color: rgba(255,255,255,0.9); font-size: 1.1rem; margin-bottom: 2rem; }
              .cards { display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; }
              .card { background: white; border-radius: 16px; padding: 2rem; width: 280px; text-decoration: none; color: inherit; transition: transform 0.3s, box-shadow 0.3s; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
              .card:hover { transform: translateY(-10px); box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
              .card h2 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #333; }
              .card p { color: #666; font-size: 0.95rem; margin-bottom: 1rem; }
              .card .icon { font-size: 3rem; margin-bottom: 1rem; }
              .backend { border-top: 4px solid #38a169; }
              .frontend { border-top: 4px solid #3182ce; }
              .footer { margin-top: 2rem; color: rgba(255,255,255,0.7); font-size: 0.9rem; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1> Documentaci贸n del Proyecto</h1>
              <p>Mapa Interactivo - Documentaci贸n t茅cnica generada autom谩ticamente</p>
              <div class="cards">
                <a href="./backend/" class="card backend">
                  <div class="icon">锔</div>
                  <h2>Backend</h2>
                  <p>API REST con Node.js y Express. Endpoints, modelos y configuraci贸n.</p>
                </a>
                <a href="./frontend/" class="card frontend">
                  <div class="icon"></div>
                  <h2>Frontend</h2>
                  <p>Aplicaci贸n React con TypeScript. Componentes, servicios y tipos.</p>
                </a>
              </div>
              <p class="footer">Generado autom谩ticamente con JSDoc y TypeDoc</p>
            </div>
          </body>
          </html>
          EOF

      # ========== DEPLOY ==========
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs-generated
          commit_message: ' Update project documentation'
          force_orphan: true

      - name: Comment PR with docs link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: ' La documentaci贸n estar谩 disponible en:\n- **Backend:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/backend/\n- **Frontend:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/frontend/'
            })

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-documentation
          path: docs-generated/
          retention-days: 30
