name: Generate Project Documentation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create docs output directory
        run: mkdir -p docs-generated/backend docs-generated/frontend

      # ========== BACKEND DOCUMENTATION (JSDoc) ==========
      - name: Install JSDoc globally
        run: npm install -g jsdoc

      - name: Generate Backend JSDoc documentation
        run: |
          cd backend
          jsdoc -c jsdoc.simple.json -r || jsdoc server.js routes/ models/ config/ data/ -r -d ../docs-generated/backend --readme ../README.md

      # ========== FRONTEND DOCUMENTATION (TypeDoc) ==========
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install --legacy-peer-deps

      - name: Install TypeDoc
        run: npm install -g typedoc@0.25.13

      - name: Generate Frontend TypeDoc documentation
        run: |
          cd frontend
          typedoc src/index.tsx src/App.tsx src/types.ts \
            src/components/WorldMap.tsx \
            src/components/TranslationModal.tsx \
            src/components/GuessGameMode.tsx \
            src/components/FlagGameMode.tsx \
            src/components/LandingPage.tsx \
            src/components/SearchBar.tsx \
            src/components/GameOverModal.tsx \
            src/components/AboutModal.tsx \
            src/components/AppLogo.tsx \
            src/services/translationService.ts \
            src/services/gameService.ts \
            src/contexts/LanguageContext.tsx \
            src/data/countryCodeMapping.ts \
            src/data/countryColors.ts \
            src/i18n/translations.ts \
            --out ../docs-generated/frontend \
            --name "Transkarte Frontend" \
            --excludePrivate \
            --excludeExternals \
            --categorizeByGroup true

      # ========== CREATE INDEX PAGE ==========
      - name: Create documentation index page
        run: |
          cat > docs-generated/index.html << 'INDEXEOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Documentaci√≥n T√©cnica - Transkarte</title>
            <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìö%3C/text%3E%3C/svg%3E">
            <style>
              *{margin:0;padding:0;box-sizing:border-box}
              body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);min-height:100vh;color:#fff}
              .header{text-align:center;padding:3rem 2rem 2rem;background:rgba(0,0,0,0.2)}
              .logo{font-size:4rem;margin-bottom:1rem}
              h1{font-size:2.5rem;margin-bottom:.5rem;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
              .subtitle{color:rgba(255,255,255,.7);font-size:1.1rem;margin-bottom:0}
              .container{max-width:1000px;margin:0 auto;padding:2rem}
              .section-title{font-size:1.5rem;margin:2rem 0 1rem;display:flex;align-items:center;gap:.5rem}
              .section-title span{font-size:1.2rem}
              .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}
              .card{background:rgba(255,255,255,0.05);border-radius:16px;padding:1.5rem;text-decoration:none;color:inherit;transition:all .3s ease;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(10px)}
              .card:hover{transform:translateY(-5px);background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2)}
              .card-header{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
              .card-icon{font-size:2.5rem;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:12px}
              .backend .card-icon{background:linear-gradient(135deg,#38a169,#2f855a)}
              .frontend .card-icon{background:linear-gradient(135deg,#3182ce,#2b6cb0)}
              .card h3{font-size:1.3rem}
              .card p{color:rgba(255,255,255,.7);font-size:.9rem;line-height:1.5;margin-bottom:1rem}
              .tech-tags{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem}
              .tech-tag{background:rgba(255,255,255,0.1);padding:.25rem .75rem;border-radius:20px;font-size:.75rem;color:rgba(255,255,255,.8)}
              .card-link{display:inline-flex;align-items:center;gap:.5rem;color:#667eea;font-weight:600;font-size:.9rem}
              .card-link:hover{color:#764ba2}
              .features{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-top:1rem}
              .feature{background:rgba(255,255,255,0.03);padding:1rem;border-radius:8px;border:1px solid rgba(255,255,255,0.05)}
              .feature-icon{font-size:1.5rem;margin-bottom:.5rem}
              .feature h4{font-size:.9rem;margin-bottom:.25rem}
              .feature p{font-size:.8rem;color:rgba(255,255,255,.6)}
              .footer{text-align:center;padding:2rem;color:rgba(255,255,255,.5);font-size:.85rem;border-top:1px solid rgba(255,255,255,0.1);margin-top:2rem}
              .footer a{color:#667eea;text-decoration:none}
              .footer a:hover{text-decoration:underline}
            </style>
          </head>
          <body>
            <header class="header">
              <div class="logo">üó∫Ô∏è</div>
              <h1>Transkarte</h1>
              <p class="subtitle">Documentaci√≥n T√©cnica del Proyecto</p>
            </header>
            
            <main class="container">
              <h2 class="section-title"><span>üìÅ</span> Documentaci√≥n por M√≥dulo</h2>
              
              <div class="cards">
                <a href="./backend/index.html" class="card backend">
                  <div class="card-header">
                    <div class="card-icon">‚öôÔ∏è</div>
                    <div>
                      <h3>Backend</h3>
                      <span style="color:rgba(255,255,255,.5);font-size:.8rem">API REST</span>
                    </div>
                  </div>
                  <p>Servidor Node.js con Express que gestiona la l√≥gica de juego, traducciones y estad√≠sticas. Incluye conexi√≥n a MongoDB.</p>
                  <div class="tech-tags">
                    <span class="tech-tag">Node.js</span>
                    <span class="tech-tag">Express</span>
                    <span class="tech-tag">MongoDB</span>
                    <span class="tech-tag">Mongoose</span>
                  </div>
                  <span class="card-link">Ver documentaci√≥n ‚Üí</span>
                </a>
                
                <a href="./frontend/index.html" class="card frontend">
                  <div class="card-header">
                    <div class="card-icon">üé®</div>
                    <div>
                      <h3>Frontend</h3>
                      <span style="color:rgba(255,255,255,.5);font-size:.8rem">Aplicaci√≥n Web</span>
                    </div>
                  </div>
                  <p>Aplicaci√≥n React con TypeScript que renderiza el mapa interactivo, gestiona modos de juego y proporciona la interfaz de usuario.</p>
                  <div class="tech-tags">
                    <span class="tech-tag">React 18</span>
                    <span class="tech-tag">TypeScript</span>
                    <span class="tech-tag">Vite</span>
                    <span class="tech-tag">react-simple-maps</span>
                  </div>
                  <span class="card-link">Ver documentaci√≥n ‚Üí</span>
                </a>
              </div>
              
              <h2 class="section-title"><span>üéÆ</span> Modos de Juego</h2>
              <div class="features">
                <div class="feature">
                  <div class="feature-icon">üåç</div>
                  <h4>Traducci√≥n</h4>
                  <p>Traduce palabras del idioma del pa√≠s seleccionado en el mapa</p>
                </div>
                <div class="feature">
                  <div class="feature-icon">üéØ</div>
                  <h4>Adivina el Idioma</h4>
                  <p>Identifica el idioma de una frase mostrada aleatoriamente</p>
                </div>
                <div class="feature">
                  <div class="feature-icon">üö©</div>
                  <h4>Adivina la Bandera</h4>
                  <p>Relaciona banderas con sus pa√≠ses correspondientes</p>
                </div>
              </div>
              
              <h2 class="section-title"><span>üìã</span> Estructura del Proyecto</h2>
              <div class="features">
                <div class="feature">
                  <div class="feature-icon">üìÇ</div>
                  <h4>backend/</h4>
                  <p>server.js, routes/, models/, config/, data/</p>
                </div>
                <div class="feature">
                  <div class="feature-icon">üìÇ</div>
                  <h4>frontend/src/</h4>
                  <p>components/, services/, contexts/, data/, i18n/</p>
                </div>
                <div class="feature">
                  <div class="feature-icon">üê≥</div>
                  <h4>Docker</h4>
                  <p>docker-compose.yml, Dockerfiles para despliegue</p>
                </div>
                <div class="feature">
                  <div class="feature-icon">üìÑ</div>
                  <h4>docs/</h4>
                  <p>Documentaci√≥n del proyecto acad√©mico</p>
                </div>
              </div>
            </main>
            
            <footer class="footer">
              <p>
                Generado autom√°ticamente con JSDoc y TypeDoc | 
                <a href="https://github.com/sdurutr436/ProyectoIntermodular-MapaInteractivo">Ver en GitHub</a>
              </p>
            </footer>
          </body>
          </html>
          INDEXEOF

      - name: List generated files
        run: |
          echo "=== Generated documentation ==="
          ls -la docs-generated/
          echo "=== Backend docs ==="
          ls -la docs-generated/backend/ || echo "Backend folder empty or not found"
          echo "=== Frontend docs ==="
          ls -la docs-generated/frontend/ || echo "Frontend folder empty or not found"

      # ========== DEPLOY ==========
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs-generated
          force_orphan: true

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-documentation
          path: docs-generated/
          retention-days: 30
